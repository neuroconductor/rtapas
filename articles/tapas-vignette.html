<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>rtapas: An R Package to Implement Thresholding Approach for Probability Map Automatic Segmentation (TAPAS) • rtapas</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="rtapas: An R Package to Implement Thresholding Approach for Probability Map Automatic Segmentation (TAPAS)">
<meta property="og:description" content="rtapas">
<meta property="og:image" content="https://avalcarcel9.github.io/rtapas/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rtapas</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tapas-vignette.html">rtapas: An R Package to Implement Thresholding Approach for Probability Map Automatic Segmentation (TAPAS)</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/avalcarcel9/rtapas/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="tapas-vignette_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>rtapas: An R Package to Implement Thresholding Approach for Probability Map Automatic Segmentation (TAPAS)</h1>
                        <h4 data-toc-skip class="author">Alessandra Valcarcel</h4>
            
            <h4 data-toc-skip class="date">2021-05-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/avalcarcel9/rtapas/blob/master/vignettes/tapas-vignette.Rmd" class="external-link"><code>vignettes/tapas-vignette.Rmd</code></a></small>
      <div class="hidden name"><code>tapas-vignette.Rmd</code></div>

    </div>

    
    
<p>This package is documented using <code>pkgdown</code>. You can find the general <code>rtapas</code> <code>pkgdown</code> site <a href="https://avalcarcel9.github.io/rtapas/">here</a> and the tutorial/vignette <a href="https://avalcarcel9.github.io/rtapas/articles/tapas-vignette.html">here</a>. The GitHub tutorial/vignette is available <a href="https://github.com/avalcarcel9/rtapas/blob/master/vignettes/tapas-vignette.md" class="external-link">here</a>.</p>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor" aria-hidden="true"></a>Overview <img src="../man/figures/logo.svg" align="right" alt="" width="120">
</h1>
<p>The <code>rtapas</code> package determines a subject-specific threshold to apply to multiple sclerosis lesion probability maps for automatic segmentation. This R package is based on the Thresholding Approach for Probability Map Automatic Segmentation (TAPAS) method. The methods are in progress for publication. This package creates the data structures necessary for training the TAPAS model. After training, the model can be used to predict subject-specific thresholds to use on probability maps for automatic lesion segmentation. Methods can be extended outside of multiple sclerosis lesion segmentation but have not been validated.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor" aria-hidden="true"></a>Installation</h2>
<p>To install the package from <a href="www.neuroconductor.org">Neuroconductor</a>, type:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"https://neuroconductor.org/neurocLite.R"</span><span class="op">)</span>
<span class="fu">neuro_install</span><span class="op">(</span><span class="st">"rtapas"</span><span class="op">)</span></code></pre></div>
<p>To get the latest development version from GitHub:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages('remotes')</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org" class="external-link">remotes</a></span><span class="op">)</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">'avalcarcel9/rtapas'</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="packages" class="section level1">
<h1 class="hasAnchor">
<a href="#packages" class="anchor" aria-hidden="true"></a>Packages</h1>
<p>The packages you will need to load for use with this tutorial are below:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/avalcarcel9/rtapas" class="external-link">rtapas</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">neurobase</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://rig.oro.us.com" class="external-link">oro.nifti</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/avalcarcel9/aliviateR" class="external-link">aliviateR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="tutorial-data" class="section level1">
<h1 class="hasAnchor">
<a href="#tutorial-data" class="anchor" aria-hidden="true"></a>Tutorial Data</h1>
<p>TAPAS is a post-hoc approach to determine a subject-specific threshold for automatic segmentation of probability maps in the context of MS lesions. To apply TAPAS, users should first run an automatic segmentation method of choice to obtain probability maps. At this point, TAPAS can be applied in order to obtain subject-specific thresholds for segmentation. In the original TAPAS work we used MIMoSA (<a href="https://onlinelibrary.wiley.com/doi/full/10.1111/jon.12506" class="external-link">1</a>,<a href="https://www.sciencedirect.com/science/article/pii/S2213158218303231" class="external-link">2</a>) as the automatic segmentation algorithm to generate probability maps which has software available on <a href="https://neuroconductor.org/package/mimosa" class="external-link">Neuroconductor</a> and documentation on <a href="https://github.com/avalcarcel9/mimosa/blob/master/vignettes/mimosa_git.md" class="external-link">GitHub</a>. The data provided in this package and used throughout this vignette are synthetic. The package contains 15 3D “gold standard” masks that were created by Alessandra Valcarcel to appear similar to manually segmented lesion masks. The package also includes “probability maps” that were created by randomly generating uniform data for each subject inside of the “gold standard” masks and then smoothing the maps. Each map is generated using different end points so that the probability distribution is variable across subjects. The package also contains a single brain mask that applies to all synthetic gold standard and probability maps. The first slice is an empty slice while the second slice contains a the probability density and the gold standard manual segmentations. We use a single empty slice simply to make images 3D. Since these probability maps are generated randomly from a uniform distribution the spatial distribution of probability is quite different than real data.</p>
<p>The authors would like to re-iterate that all data available in the package and used throughout this vignette are synthetic and created by the authors simply for demonstration of the package usage. The data is meant to mimic a simple set of real data.</p>
<p>The data contained in this package contains 3D arrays for 15 synthetic gold standard segmentations (<code>gs#</code>), 15 probability maps (<code>pmap#</code>), and a single brain mask (<code>brain_mask</code>) that can be used for all 30 images. The <code>#</code> value noted can be any number 1-15. Package data is set to <code>Lazy Data: true</code> and will therefore be automatically loaded with the package. We use 10 subjects for training the TAPAS model and then evaluate the model using 5 subjects excluded from training in this tutorial. The gold standard segmentations and probability maps consist of a single slice with voxel values and a second slice where all voxels are equal to 0. The brain mask contains a brain mask value in both slices. These are saved as arrays which we will convert to <code>nifti</code> objects.</p>
</div>
<div id="load-training-data" class="section level1">
<h1 class="hasAnchor">
<a href="#load-training-data" class="anchor" aria-hidden="true"></a>Load Training Data</h1>
<p>To use the data throughout this tutorial we will initialize the 10 gold standard masks, 10 probability maps, and 10 brain masks into a list.</p>
<div id="training-gold-standard-masks" class="section level2">
<h2 class="hasAnchor">
<a href="#training-gold-standard-masks" class="anchor" aria-hidden="true"></a>Training Gold Standard Masks</h2>
<p>The gold standard masks are all saved as <code>gs#</code>. We will use the first 10 to train the TAPAS model.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make a list of the gold standard masks</span>
<span class="va">train_gold_standard_masks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gs1 <span class="op">=</span> <span class="va">gs1</span>, 
                                 gs2 <span class="op">=</span> <span class="va">gs2</span>, 
                                 gs3 <span class="op">=</span> <span class="va">gs3</span>, 
                                 gs4 <span class="op">=</span> <span class="va">gs4</span>, 
                                 gs5 <span class="op">=</span> <span class="va">gs5</span>, 
                                 gs6 <span class="op">=</span> <span class="va">gs6</span>, 
                                 gs7 <span class="op">=</span> <span class="va">gs7</span>, 
                                 gs8 <span class="op">=</span> <span class="va">gs8</span>, 
                                 gs9 <span class="op">=</span> <span class="va">gs9</span>, 
                                 gs10 <span class="op">=</span> <span class="va">gs10</span><span class="op">)</span>

<span class="co"># Convert the gold standard masks to nifti objects</span>
<span class="va">train_gold_standard_masks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">train_gold_standard_masks</span>, <span class="fu">oro.nifti</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/oro.nifti/man/nifti.html" class="external-link">nifti</a></span><span class="op">)</span></code></pre></div>
<p>The gold standard segmentations are visualized below:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Show the gold standard masks using patchwork</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs2</span><span class="op">)</span> <span class="op">+</span> 
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs3</span><span class="op">)</span> <span class="op">+</span> <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs4</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs5</span><span class="op">)</span> <span class="op">+</span> <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs6</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs7</span><span class="op">)</span> <span class="op">+</span> <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs8</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs9</span><span class="op">)</span> <span class="op">+</span> <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">$</span><span class="va">gs10</span><span class="op">)</span> </code></pre></div>
</div>
<div id="training-probability-maps" class="section level2">
<h2 class="hasAnchor">
<a href="#training-probability-maps" class="anchor" aria-hidden="true"></a>Training Probability Maps</h2>
<p>The probability maps are all saved as <code>pmap#</code>. We will use the first 10 to train the TAPAS model.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make a list of the training probability maps</span>
<span class="va">train_probability_maps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pmap1 <span class="op">=</span> <span class="va">pmap1</span>, 
                              pmap2 <span class="op">=</span> <span class="va">pmap2</span>, 
                              pmap3 <span class="op">=</span> <span class="va">pmap3</span>, 
                              pmap4 <span class="op">=</span> <span class="va">pmap4</span>, 
                              pmap5 <span class="op">=</span> <span class="va">pmap5</span>, 
                              pmap6 <span class="op">=</span> <span class="va">pmap6</span>, 
                              pmap7 <span class="op">=</span> <span class="va">pmap7</span>, 
                              pmap8 <span class="op">=</span> <span class="va">pmap8</span>, 
                              pmap9 <span class="op">=</span> <span class="va">pmap9</span>, 
                              pmap10 <span class="op">=</span> <span class="va">pmap10</span><span class="op">)</span>

<span class="co"># Convert the probability maps to nifti objects</span>
<span class="va">train_probability_maps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">train_probability_maps</span>, <span class="fu">oro.nifti</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/oro.nifti/man/nifti.html" class="external-link">nifti</a></span><span class="op">)</span></code></pre></div>
<p>The probability maps are visualized below:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Show the probability maps using patchwork</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap1</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap2</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap3</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap4</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap5</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap6</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap7</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap8</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap9</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">$</span><span class="va">pmap10</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
</div>
<div id="training-brain-mask" class="section level2">
<h2 class="hasAnchor">
<a href="#training-brain-mask" class="anchor" aria-hidden="true"></a>Training Brain Mask</h2>
<p>There is only one brain mask included in the example data with this package. This mask was created manually just to cover all the “brain matter” in the gold standard masks and probability maps. Often each subject will have a unique brain mask depending on the registration technique. Below we create a list of brain masks so that the indices match the indices of the gold standard list and probability map list.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make a list of the brain masks</span>
<span class="va">train_brain_masks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>brain_mask1 <span class="op">=</span> <span class="va">brain_mask</span>, 
                         brain_mask2 <span class="op">=</span> <span class="va">brain_mask</span>, 
                         brain_mask3 <span class="op">=</span> <span class="va">brain_mask</span>, 
                         brain_mask4 <span class="op">=</span> <span class="va">brain_mask</span>, 
                         brain_mask5 <span class="op">=</span> <span class="va">brain_mask</span>, 
                         brain_mask6 <span class="op">=</span> <span class="va">brain_mask</span>, 
                         brain_mask7 <span class="op">=</span> <span class="va">brain_mask</span>, 
                         brain_mask8 <span class="op">=</span> <span class="va">brain_mask</span>, 
                         brain_mask9 <span class="op">=</span> <span class="va">brain_mask</span>, 
                         brain_mask10 <span class="op">=</span> <span class="va">brain_mask</span><span class="op">)</span>

<span class="co"># Convert the brain masks to nifti objects</span>
<span class="va">train_brain_masks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">train_brain_masks</span>, <span class="fu">oro.nifti</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/oro.nifti/man/nifti.html" class="external-link">nifti</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="training-subject-id" class="section level2">
<h2 class="hasAnchor">
<a href="#training-subject-id" class="anchor" aria-hidden="true"></a>Training Subject ID</h2>
<p>We will also need a vector of subject IDs to include. We simply create an ID vector below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train_ids</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'subject_'</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">train_gold_standard_masks</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="generating-tapas-model-data" class="section level1">
<h1 class="hasAnchor">
<a href="#generating-tapas-model-data" class="anchor" aria-hidden="true"></a>Generating TAPAS Model Data</h1>
<p>Before we can fit the TAPAS model, we have to generate the threshold data required for model input. The model requires the Sørensen–Dice coefficient value evaluated across all <code>thresholds</code> values for each subject in the training set. We suggest evaluating thresholds from 0 to 1 by 1% increments. This can be carried out using two functions: <code>tapas_data</code> and <code>tapas_data_par</code>. The <code>tapas_data</code> function will produce the model data for a single subject whereas <code>tapas_data_par</code> is a wrapper around <code>tapas_data</code> and will run in parallel for multiple subjects.</p>
<p>Below we will calculate the TAPAS model input data using the example data subject by subject using <code>tapas_data</code>. We implement a <code>for</code> loop for simplicity. The <code>pmap</code>, <code>gold_standard</code>, and <code>mask</code> inputs must be either a local object of class <code>nifti</code> or a vector of file paths to a <code>nifti</code> object. The <code>subject_id</code> is simply a vector of subject IDs. These can be character or numeric. For this example we set <code>k = 0</code> since the data is only a single slice of segmented values and probability maps were randomly generated from a uniform. The <code>thresholds</code> and <code>verbose</code> inputs are all set to the default.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Initialize an empty list to store results created on 1 core</span>
<span class="va">train_data1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Run tapas_data function</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">train_probability_maps</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">train_data1</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/tapas_data.html">tapas_data</a></span><span class="op">(</span>thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>,
                         pmap <span class="op">=</span> <span class="va">train_probability_maps</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
                         gold_standard <span class="op">=</span> <span class="va">train_gold_standard_masks</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
                         mask <span class="op">=</span> <span class="va">train_brain_masks</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
                         k <span class="op">=</span> <span class="fl">0</span>,
                         subject_id <span class="op">=</span> <span class="va">train_ids</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
                         verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The <code>tapas_data_par</code> function simply is a parallel wrapper around <code>tapas_data</code>. Before we look at the return objects from these functions let’s replicate the results from <code>tapas_data</code> using <code>tapas_data_par</code> with 2 cores. The <code>tapas_data_par</code> function is compatible with on both Unix and Windows machines. Again, the code below is going to run on 2 cores so be sure your machine has access to 2 cores or reduce back down to 1.</p>
<p>The inputs for <code>tapas_data_par</code> are similar to the <code>tapas_data</code> function but instead of single subject values we use either a <code>list</code> of <code>nifti</code> objects or a <code>vector</code> of file paths to <code>nifti</code> objects. By setting <code>ret = TRUE</code> the subject TAPAS data generated by the wrapped <code>tapas_data</code> function will be returned locally in as a <code>list</code>. This object may be extremely large depending on the number of subjects used for training so be aware of memory constraints if returning these objects locally. By default <code>outfile = NULL</code> and the subject-level TAPAS data generated will not be saved out. If users would like to save the subject-level data out then users must specify a vector of file paths with <code>.rda</code> or <code>.RData</code> file extensions included. Be sure that across <code>list</code> and <code>vector</code> inputs the subject-level information is sorted and consistent across each input.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Store results created on 2 cores</span>
<span class="co"># Run tapas_data_par function</span>
<span class="va">train_data2</span> <span class="op">=</span> <span class="fu"><a href="../reference/tapas_data_par.html">tapas_data_par</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">2</span>, 
                             thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>, 
                             pmap <span class="op">=</span> <span class="va">train_probability_maps</span>, 
                             gold_standard <span class="op">=</span> <span class="va">train_gold_standard_masks</span>, 
                             mask <span class="op">=</span> <span class="va">train_brain_masks</span>, 
                             k <span class="op">=</span> <span class="fl">0</span>, 
                             subject_id <span class="op">=</span> <span class="va">train_ids</span>,
                             ret <span class="op">=</span> <span class="cn">TRUE</span>, 
                             outfile <span class="op">=</span> <span class="cn">NULL</span>, 
                             verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>The data produced using these functions is exactly the same. The only difference is whether users would like to utilize parallel computing.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Bind the single core data across list objects (subjects)</span>
<span class="va">train_data1</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">train_data1</span><span class="op">)</span>
<span class="co"># Bind the 2 core data across list objects (subjects)</span>
<span class="va">train_data2</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">train_data2</span><span class="op">)</span>
<span class="co"># Check that datasets are equal</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">train_data1</span>, <span class="va">train_data2</span><span class="op">)</span></code></pre></div>
<p>The data returned from either of these functions is needed to train the TAPAS model. The <code>tapas_data</code> function returns a single subject level tibble while the <code>tapas_data_par</code> returns a list with each subject-level tibble as an element in the list (only if <code>ret = TRUE</code>). Each subject-level tibble contains the following columns: <code>threshold</code>, <code>dsc</code>, <code>volume</code>, and <code>subject_id</code>. The first and last 5 rows of <code>train_data1</code> are shown below:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">train_data1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">train_data1</span><span class="op">)</span></code></pre></div>
</div>
<div id="fit-the-tapas-model" class="section level1">
<h1 class="hasAnchor">
<a href="#fit-the-tapas-model" class="anchor" aria-hidden="true"></a>Fit the TAPAS Model</h1>
<p>After the TAPAS data is generated using either <code>tapas_data</code> or <code>tapas_data_par</code> the TAPAS model can be fit using the <code>tapas_train</code> function. The subject training data must either be a binded <code>tibble</code> or <code>data.frame</code> or a list with each element the subject data. Previously, we binded the data together to compare <code>train_data1</code> and <code>train_data2</code> so we will use the <code>tibble</code> produced from above. We did this above when checking that <code>train_data1</code> and <code>train_data2</code> are equal.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tapas_model</span> <span class="op">=</span> <span class="fu"><a href="../reference/tapas_train.html">tapas_train</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">train_data1</span>, 
                          dsc_cutoff <span class="op">=</span> <span class="fl">0.03</span>, 
                          verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>The return object from running <code>tapas_train</code> includes a list with the model in the named element <code>tapas_model</code>, the group threshold in the named element <code>group_threshold</code>, and the information about the clamping thresholds in the element <code>clamp_data</code>. Let’s look at these objects:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># The TAPAS GAM model</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tapas_model</span><span class="op">$</span><span class="va">tapas_model</span><span class="op">)</span>
<span class="co"># The threshold that optimizes group-level DSC</span>
<span class="va">tapas_model</span><span class="op">$</span><span class="va">group_threshold</span>
<span class="co"># The lower and upper bound clamps to avoid extrapolation</span>
<span class="va">tapas_model</span><span class="op">$</span><span class="va">clamp_data</span>
<span class="co"># The training data for the TAPAS `mgcv::gam` function</span>
<span class="va">tapas_model</span><span class="op">$</span><span class="va">train_data</span></code></pre></div>
<p>We can run some quality control on the TAPAS model fit by evaluating scatter plots and histograms of the subject-specific best threshold detected in the training data. We have included a function in the package <code>make_scattergram</code> which visualize the subject-specific thresholds selected using both a scatter plot of the subject-specific best threshold from training data on the subject ID with a marginal histogram of the thresholds. This function will help users re-fine the TAPAS threshold grid applied when running <code>tapas_data</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/make_scattergram.html">make_scattergram</a></span><span class="op">(</span>tapas_model <span class="op">=</span> <span class="va">tapas_model</span><span class="op">)</span></code></pre></div>
<p>Recall when we implemented <code>tapas_data</code> or <code>tapas_data_par</code> we used a threshold grid of 0% to 100% in 1% increments. Using this scatter plot with a marginal histogram you’ll notice the subject-specific thresholds selected from the training data range from about 6% to 18%. For optimal TAPAS performance, we suggest refining the threshold grid used to better align with the training data. In this case, perhaps 5% to 25%. It may be useful to assess the predicted subject-specific thresholds on some test set subjects to inform the threshold grid selected as well. This may require a few iterations of models where you:</p>
<ol style="list-style-type: decimal">
<li>Run <code>tapas_data</code> or <code>tapas_data_par</code> with a specified threshold grid</li>
<li>Fit the TAPAS model with <code>tapas_train</code>
</li>
<li>Assess the threshold grid in the training data</li>
<li>Assess the threshold grid in the testing data</li>
<li>Repeat as necessary until threshold grid is refined</li>
</ol>
<p>Once refined and TAPAS fits to your liking, we can use this model to predict a subject-specific thresholds, create a segmentation mask using this threshold, and create a segmentation mask using the group-threshold for a subjects not included in model training.</p>
</div>
<div id="load-testing-data" class="section level1">
<h1 class="hasAnchor">
<a href="#load-testing-data" class="anchor" aria-hidden="true"></a>Load Testing Data</h1>
<p>To use the data throughout the testing of the model we will initialize the remaining 5 gold standard masks, 5 probability maps, and 5 brain masks not used in the training procedure into a list.</p>
<div id="testing-gold-standard-masks" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-gold-standard-masks" class="anchor" aria-hidden="true"></a>Testing Gold Standard Masks</h2>
<p>The gold standard masks are all saved as <code>gs#</code>. We will use the last 5 to train the TAPAS model.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Testing gold standard masks</span>
<span class="va">test_gold_standard_masks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gs11 <span class="op">=</span> <span class="va">gs11</span>,
                                gs12 <span class="op">=</span> <span class="va">gs12</span>,
                                gs13 <span class="op">=</span> <span class="va">gs13</span>,
                                gs14 <span class="op">=</span> <span class="va">gs14</span>,
                                gs15 <span class="op">=</span> <span class="va">gs15</span><span class="op">)</span>

<span class="co"># Make array objects niftis</span>
<span class="va">test_gold_standard_masks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span>, <span class="fu">oro.nifti</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/oro.nifti/man/nifti.html" class="external-link">nifti</a></span><span class="op">)</span>

<span class="co"># Visualize the testing subjects gold standard masks</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">$</span><span class="va">gs11</span><span class="op">)</span> <span class="op">+</span> <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">$</span><span class="va">gs12</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">$</span><span class="va">gs13</span><span class="op">)</span> <span class="op">+</span> <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">$</span><span class="va">gs14</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">$</span><span class="va">gs15</span><span class="op">)</span></code></pre></div>
<p>The gold standard segmentations are visualized below:</p>
</div>
<div id="testing-probability-maps" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-probability-maps" class="anchor" aria-hidden="true"></a>Testing Probability Maps</h2>
<p>The probability maps are all saved as <code>pmap#</code>. We will use the last 5 to train the TAPAS model.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Obtain the test subject probability maps</span>
<span class="va">test_probability_maps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pmap11 <span class="op">=</span> <span class="va">pmap11</span>, 
                             pmap12 <span class="op">=</span> <span class="va">pmap12</span>,
                             pmap13 <span class="op">=</span> <span class="va">pmap13</span>,
                             pmap14 <span class="op">=</span> <span class="va">pmap14</span>,
                             pmap15 <span class="op">=</span> <span class="va">pmap15</span><span class="op">)</span>

<span class="co"># Make array objects niftis</span>
<span class="va">test_probability_maps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">test_probability_maps</span>, <span class="fu">oro.nifti</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/oro.nifti/man/nifti.html" class="external-link">nifti</a></span><span class="op">)</span>

<span class="co"># Visualize the 5 testing probability maps</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_probability_maps</span><span class="op">$</span><span class="va">pmap11</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_probability_maps</span><span class="op">$</span><span class="va">pmap12</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_probability_maps</span><span class="op">$</span><span class="va">pmap13</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_probability_maps</span><span class="op">$</span><span class="va">pmap14</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_probability_maps</span><span class="op">$</span><span class="va">pmap15</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The probability maps are visualized below:</p>
</div>
<div id="testing-brain-masks" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-brain-masks" class="anchor" aria-hidden="true"></a>Testing Brain Masks</h2>
<p>There is only one brain mask included in the example data with this package. This mask was created manually just to cover all the “brain matter” in the gold standard masks and probability maps. Often each subject will have a unique brain mask depending on the registration technique. Below we create a list of brain masks so that the indices match the indices of the gold standard list and probability map list.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create a list of testing brain masks</span>
<span class="va">test_brain_masks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>brain_mask11 <span class="op">=</span> <span class="va">brain_mask</span>, 
                        brain_mask12 <span class="op">=</span> <span class="va">brain_mask</span>,
                        brain_mask13 <span class="op">=</span> <span class="va">brain_mask</span>,
                        brain_mask14 <span class="op">=</span> <span class="va">brain_mask</span>,
                        brain_mask15 <span class="op">=</span> <span class="va">brain_mask</span><span class="op">)</span>

<span class="co"># Make array objects niftis</span>
<span class="va">test_brain_masks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">test_brain_masks</span>, <span class="fu">oro.nifti</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/oro.nifti/man/nifti.html" class="external-link">nifti</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="testing-subject-id" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-subject-id" class="anchor" aria-hidden="true"></a>Testing Subject ID</h2>
<p>We will also need a vector of subject IDs to include. We simply create an ID vector below:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_ids</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'subject_'</span>, <span class="op">(</span><span class="fl">10</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="predicting-thresholds-and-segmentation-masks" class="section level1">
<h1 class="hasAnchor">
<a href="#predicting-thresholds-and-segmentation-masks" class="anchor" aria-hidden="true"></a>Predicting Thresholds and Segmentation Masks</h1>
<p>Below we will predict using the TAPAS model subject by subject using <code>tapas_predict</code>. We implement a <code>for</code> loop for simplicity. The <code>pmap</code> and <code>mask</code> inputs must be either a local object of class <code>nifti</code> or a vector of file paths to a <code>nifti</code> object. The <code>subject_id</code> is simply a vector of subject IDs. These can be character or numeric. For this example we set <code>k = 0</code> since the data is only a single slice of segmented values and probability maps were randomly generated from a uniform. We use the default <code>clamp = TRUE</code> which will use the threshold associated with the 10th or 90th percentile volume from the training data rather than the subject-specific fitted value. This is to avoid extrapolation in the tails of the TAPAS model. The <code>verbose</code> input is set to <code>TRUE</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Initialize an empty list to store results created on 1 core</span>
<span class="va">test_data1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Run tapas_predict function</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">test_probability_maps</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">test_data1</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/tapas_predict.html">tapas_predict</a></span><span class="op">(</span>pmap <span class="op">=</span> <span class="va">test_probability_maps</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
                                  model <span class="op">=</span> <span class="va">tapas_model</span>,
                                  clamp <span class="op">=</span> <span class="cn">TRUE</span>,
                                  k <span class="op">=</span> <span class="fl">0</span>,
                                  verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The <code>tapas_predict_par</code> function simply is a parallel wrapper around <code>tapas_predict</code>. Before we look at the return objects from these functions let’s replicate the results from <code>tapas_predict</code> using <code>tapas_predict_par</code> with 2 cores. The <code>tapas_predict_par</code> function is compatible with on both Unix and Windows machines. Again, the code below is going to run on 2 cores so be sure your machine has access to 2 cores or reduce back down to 1.</p>
<p>The inputs for <code>tapas_predict_par</code> are similar to the <code>tapas_predict</code> function but instead of single subject values include either a <code>list</code> of <code>nifti</code> objects or a <code>vector</code> of file paths to <code>nifti</code> objects. By setting <code>ret = TRUE</code> the TAPAS predicted subject data generated by the wrapped <code>tapas_predict</code> function will be returned locally as a <code>list</code>. This object may be extremely large depending on the number of subjects used for training so be aware of memory constraints if returning these objects locally. By default <code>outfile = NULL</code> and the predicted subject-level data generated will not be saved out. If users would like to save the predicted subject-level data out then users must specify a vector of file names with <code>.rda</code> or <code>.RData</code> file extensions included. Be sure that across <code>list</code> and <code>vector</code> inputs the subject-level information is sorted and consistent across each input.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Store results created on 2 cores</span>
<span class="co"># Run tapas_predict_par function</span>
<span class="va">test_data2</span> <span class="op">=</span> <span class="fu"><a href="../reference/tapas_predict_par.html">tapas_predict_par</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">2</span>, 
                               pmap <span class="op">=</span> <span class="va">test_probability_maps</span>, 
                               subject_id <span class="op">=</span> <span class="va">test_ids</span>, 
                               model <span class="op">=</span> <span class="va">tapas_model</span>, 
                               clamp <span class="op">=</span> <span class="cn">TRUE</span>,
                               k <span class="op">=</span> <span class="fl">0</span>, 
                               ret <span class="op">=</span> <span class="cn">TRUE</span>, 
                               outfile <span class="op">=</span> <span class="cn">NULL</span>, 
                               verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>The data produced using these functions is exactly the same. The only difference is whether users would like to utilize parallel computing. Below we show that the data produced for subject 11 is the same in both:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">subject_threshold</span>, <span class="va">test_data2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">subject_threshold</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">test_data2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">test_data2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The <code>tapas_predict</code> function returns a list containing the TAPAS predicted <code>subject_threshold</code>, the binary segmentation mask produced by applying the TAPAS predicted <code>subject_threshold</code> called <code>tapas_binary_mask</code>, and the binary segmentation mask produced by applying the group threshold <code>group_binary_mask</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
<div id="evaluate-performance" class="section level1">
<h1 class="hasAnchor">
<a href="#evaluate-performance" class="anchor" aria-hidden="true"></a>Evaluate Performance</h1>
<p>Let’s visualize and quantify the masks produced by the <code>tapas_predict</code> and <code>tapas_predict_par</code> functions. First we will look at the TAPAS produced binary segmentations.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># The TAPAS binary masks</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span></code></pre></div>
<p>Now we will look at the group threshold produced binary segmentation masks.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># The group threshold binary masks</span>
<span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">image</span><span class="op">(</span><span class="va">test_data1</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span></code></pre></div>
<p>With these masks we can calculate DSC to compare the TAPAS and group threshold masks.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Calculate DSC in each mask</span>
<span class="va">dsc</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>
  tapas_dsc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span>,
                <span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span>,
                <span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span>,
                <span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span>,
                <span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tapas_binary_mask</span><span class="op">)</span><span class="op">)</span>,
  group_dsc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span>,
                <span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span>,
                <span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span>,
                <span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span>,
                <span class="fu">aliviateR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aliviateR/man/dsc.html" class="external-link">dsc</a></span><span class="op">(</span><span class="va">test_gold_standard_masks</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span>, <span class="va">test_data1</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group_binary_mask</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Print DSC</span>
<span class="va">dsc</span></code></pre></div>
</div>
<div id="thank-you" class="section level1">
<h1 class="hasAnchor">
<a href="#thank-you" class="anchor" aria-hidden="true"></a>Thank you</h1>
<p>Thank you all for the time and I hope you enjoyed the training vignette. If you have comments, questions, or suggestions please feel free to contact me by submitting an issue.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Alessandra Valcarcel.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
